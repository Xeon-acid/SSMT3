<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="SSMT.ModManagePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:SSMT"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:community="using:CommunityToolkit.WinUI.UI.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">
    

    <Grid>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="0.6*"/>
            <ColumnDefinition Width="0.4*"/>
        </Grid.ColumnDefinitions>
        
        
        <!--菜单-->
        <MenuBar Grid.Row="0" Grid.Column="0" Margin="10,5,0,0">
            <MenuBarItem Title="文件" x:Name="Menu_File">
                <MenuFlyoutItem x:Name="Menu_OpenModsFolder" Text="打开Mods文件夹" Click="Menu_OpenModsFolder_Click"/>
            </MenuBarItem>
            
        </MenuBar>
        
        <!--设置开关按钮-->
        <StackPanel
            Orientation="Horizontal"
            Grid.Row="0"
            Grid.Column="1"
            HorizontalAlignment="Left">
            <Button 
                Margin="15,0,0,0"
                ToolTipService.ToolTip="添加新的分类"
                Click="Button_ShowSetting_Click"
                x:Name="Button_ShowSetting"
                Content="添加分类"
                >
            </Button>

            <TextBlock
                Margin="5,0,0,0"
                VerticalAlignment="Center"
                Text="Mod管理仍在内测中，请狠狠提交修改意见！"
                ></TextBlock>
        </StackPanel>


        <!--一级和二级分类和Mod列表-->
        <Grid
            Margin="5"
            Grid.Row="1"
            Grid.Column="0"
            >
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!--一级Mod分类-->
            <ListView
                DoubleTapped="ListView_CategoryPrimary_DoubleTapped"
                SelectionChanged="ListView_CategoryPrimary_SelectionChanged"
                Grid.Row="0"
                Grid.Column="0"
                x:Name="ListView_CategoryPrimary"
                BorderThickness="1"
                BorderBrush="{ThemeResource ControlStrongStrokeColorDefaultBrush}">

                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem" BasedOn="{StaticResource DefaultListViewItemStyle}">
                        <Setter Property="ContextFlyout">
                            <Setter.Value>
                                <MenuFlyout 
                                    x:Name="ListViewItem_CategoryPrimary_MenuFlyout"
                                    Opening="ListViewItem_CategoryPrimary_MenuFlyout_Opening">

                                    <MenuFlyoutItem
                                        x:Name="MenuFlyoutItem_CategoryPrimary_AddNewCategory"
                                        Text="添加新的一级分类"
                                        Click="MenuFlyoutItem_CategoryPrimary_AddNewCategory_Click"
                                        >
                                        
                                    </MenuFlyoutItem>
                                    
                                    <MenuFlyoutSeparator/>

                                    <MenuFlyoutItem
                                        x:Name="MenuFlyoutItem_CategoryPrimary_ModifyIconPicture"
                                        Text="修改此分类的显示图标"
                                        Click="MenuFlyoutItem_CategoryPrimary_ModifyIconPicture_Click"/>
                                    <MenuFlyoutSeparator/>
                                    
                                    <MenuFlyoutItem 
                                        Click="MenuFlyoutItem_CategoryPrimary_DeleteSelectedCategory_Click"
                                        x:Name="MenuFlyoutItem_CategoryPrimary_DeleteSelectedCategory"
                                        Text="删除此分类及其下面所有文件夹"/>
                                    
                                </MenuFlyout>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListView.ItemContainerStyle>

                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="local:ModCategory">
                        <Grid Margin="5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="50" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <Image 
                                Grid.Column="0"
                                VerticalAlignment="Center"
                                HorizontalAlignment="Center"
                                Source="{x:Bind BackgroundImage}" 
                                Width="50" 
                                Height="50" 
                                Stretch="Fill"/>

                            <Grid Grid.Column="1">
                                <Grid.RowDefinitions>
                                    <RowDefinition></RowDefinition>
                                </Grid.RowDefinitions>

                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"></ColumnDefinition>
                                </Grid.ColumnDefinitions>
                                <Border
                                    CornerRadius="2"
                                    Grid.Row="0"
                                    Visibility="{x:Bind NotEnable}"
                                    >
                                    <Border.Background>
                                        <LinearGradientBrush StartPoint="1,1" EndPoint="0,1">
                                            <!-- 顶部完全透明 -->
                                            <GradientStop Color="Transparent" Offset="0"/>
                                            <GradientStop Color="Red" Offset="1"/>
                                        </LinearGradientBrush>
                                    </Border.Background>

                                </Border>

                                <StackPanel  Grid.Row="0">
                                    <TextBlock 
                                        Text="{x:Bind Name}" 
                                        FontSize="14" 
                                        FontWeight="SemiBold" 
                                        Style="{ThemeResource BaseTextBlockStyle}"
                                        HorizontalAlignment="Left" 
                                        Margin="0,0,0,6" 
                                        LineHeight="20"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{x:Bind ModNumber}" HorizontalAlignment="Left" Style="{ThemeResource CaptionTextBlockStyle}" />
                                        <TextBlock Text=" 个分类 " HorizontalAlignment="Left" Style="{ThemeResource CaptionTextBlockStyle}"/>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>

                            
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>


            <!--二级Mod分类，对象层-->
            <ListView
                DoubleTapped="ListView_CategorySecondary_DoubleTapped"
                SelectionChanged="ListView_CategorySecondary_SelectionChanged"
                Grid.Row="0"
                Grid.Column="1"
                x:Name="ListView_CategorySecondary"
                BorderThickness="1"
                Height="Auto"
                BorderBrush="{ThemeResource ControlStrongStrokeColorDefaultBrush}">

                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem" BasedOn="{StaticResource DefaultListViewItemStyle}">
                        <Setter Property="ContextFlyout">
                            <Setter.Value>
                                <MenuFlyout 
                                    Opening="CategorySecondary_ListViewItem_MenuFlyOut_Opening"
                                    x:Name="CategorySecondary_ListViewItem_MenuFlyOut">

                                    <MenuFlyoutItem
                                        x:Name="MenuFlyoutItem_CategorySecondary_AddNewCategory"
                                        Text="添加新的二级分类"
                                        Click="MenuFlyoutItem_CategorySecondary_AddNewCategory_Click"
                                        >
                                        
                                    </MenuFlyoutItem>
                                    
                                    <MenuFlyoutSeparator></MenuFlyoutSeparator>

                                    <MenuFlyoutItem
                                        x:Name="MenuFlyoutItem_CategorySecondary_ModifyIconPicture"
                                        Text="修改此分类的显示图标"
                                        Click="MenuFlyoutItem_CategorySecondary_ModifyIconPicture_Click"/>
                                    <MenuFlyoutSeparator/>

                                    <MenuFlyoutItem 
                                        Click="MenuFlyoutItem_CategorySecondary_DeleteSelectedLine_Click"
                                        x:Name="MenuFlyoutItem_CategorySecondary_DeleteSelectedLine"
                                        Text="删除选中分类以及下面的所有Mod文件"/>
                                </MenuFlyout>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListView.ItemContainerStyle>
                
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="local:ModCategory">
                        <Grid Margin="5">
                            
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="50" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            
                            <Image 
                                VerticalAlignment="Center"
                                HorizontalAlignment="Center"
                                Source="{x:Bind BackgroundImage}" 
                                Width="50" 
                                Height="50" 
                                Stretch="Fill"/>


                            <Grid Grid.Column="1">
                                <Grid.RowDefinitions>
                                    <RowDefinition></RowDefinition>
                                </Grid.RowDefinitions>

                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"></ColumnDefinition>
                                </Grid.ColumnDefinitions>
                                <Border
                                    CornerRadius="2"
                                    Grid.Row="0"
                                    Visibility="{x:Bind NotEnable}"
                                    >
                                    <Border.Background>
                                        <LinearGradientBrush StartPoint="1,1" EndPoint="0,1">
                                            <GradientStop Color="#44FF3333" Offset="0"/>
                                        </LinearGradientBrush>
                                    </Border.Background>

                                </Border>

                                <StackPanel 
                                    Margin="12,0,0,0" 
                                    Grid.Column="1" >
                                    <TextBlock 
                                        Text="{x:Bind Name}" 
                                        FontSize="14" 
                                        FontWeight="SemiBold" 
                                        Style="{ThemeResource BaseTextBlockStyle}"
                                        HorizontalAlignment="Left" 
                                        Margin="0,0,0,6" 
                                        MaxWidth="260"
                                        TextTrimming="CharacterEllipsis"
                                        TextWrapping="Wrap"
                                        LineHeight="20"/>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{x:Bind ModNumber}" HorizontalAlignment="Left" Style="{ThemeResource CaptionTextBlockStyle}" />
                                        <TextBlock Text=" 个Mod " HorizontalAlignment="Left" Style="{ThemeResource CaptionTextBlockStyle}"/>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>

                            
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>


            <Grid
                Grid.Row="0"
                Grid.Column="2">

                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!--Mod列表-->
                <ListView
                    Grid.Row="0"
                    SelectionChanged="ListView_ModItem_SelectionChanged"
                    DoubleTapped="ListView_ModItem_DoubleTapped"
                    x:Name="ListView_ModItem"
                    BorderThickness="1"
                    Height="Auto"
                    AllowDrop="True"
                    DragOver="ListView_ModItem_DragOver"
                    Drop="ListView_ModItem_Drop"
                    BorderBrush="{ThemeResource ControlStrongStrokeColorDefaultBrush}">

                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem" BasedOn="{StaticResource DefaultListViewItemStyle}">
                            <Setter Property="ContextFlyout">
                                <Setter.Value>
                                    <MenuFlyout 
                                        Opening="ModItem_ListViewItem_MenuFlyOut_Opening">
                                        <MenuFlyoutItem
                                            Click="MenuFlyoutItem_OpenSelectedModFolder_Click"
                                            x:Name="MenuFlyoutItem_OpenSelectedModFolder"
                                            Text="打开此Mod文件夹"/>
                                        <MenuFlyoutSeparator/>
                                        
                                        <MenuFlyoutItem 
                                            Click="MenuFlyoutItem_ModItem_OpenThisMod_Click"
                                            Text="开启此Mod"/>
                                        <MenuFlyoutItem 
                                            Click="MenuFlyoutItem_ModItem_CloseThisMod_Click"
                                            Text="关闭此Mod"/>

                                        <MenuFlyoutSeparator/>
                                        <MenuFlyoutItem 
                                            Click="MenuFlyoutItem_ModItem_DeleteSelectedMod_Click"
                                            Text="删除此Mod"
                                            x:Name="MenuFlyoutItem_ModItem_DeleteSelectedMod"/>
                                    </MenuFlyout>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListView.ItemContainerStyle>


                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="local:ModItem">
                            <Grid Margin="5" >
                                <Grid.RowDefinitions>
                                    <RowDefinition />
                                    <RowDefinition />
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <Border
                                    
                                    CornerRadius="6"
                                    Grid.Row="0"
                                    Visibility="{x:Bind Enable}"
                                    >
                                    <Border.Background>
                                        <LinearGradientBrush StartPoint="1,1" EndPoint="0,1">
                                            <GradientStop Color="#4433FF33" Offset="0"/>
                                        </LinearGradientBrush>
                                    </Border.Background>

                                </Border>
                              

                                    <StackPanel 
                                        Grid.Row="0"
                                            Margin="12,0,0,0" 
                                            Grid.Column="1" >
                                     
                                        <TextBlock 
                                            Text="{x:Bind ModName}" 
                                            FontSize="14" 
                                            FontWeight="SemiBold" 
                                            Style="{ThemeResource BaseTextBlockStyle}"
                                            HorizontalAlignment="Left" 
                                            Margin="0,0,0,6" 
     
                                            LineHeight="20"/>


                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock 
                                                Visibility="{x:Bind Enable}"
                                                Text="已启用" 
                                                HorizontalAlignment="Left" 
                                                Style="{ThemeResource CaptionTextBlockStyle}"/>
                                        </StackPanel>
                                    </StackPanel>
                                
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>

                <!--拖拽提示-->
                <Button
                    Grid.Row="1"
                    VerticalAlignment="Bottom"
                    HorizontalAlignment="Stretch"
                    x:Name="Button_AddNewMod"
                    Click="Button_AddNewMod_Click"
                    Content="↑↑↑点此或Mod拖拽到上方空白区域安装↑↑↑"
                    ></Button>
            </Grid>
            

        </Grid>
        
        <!--右侧Mod详情-->
        <Grid
            Margin="15"
            Width="Auto"
            Grid.Row="1"
            Grid.Column="1"
            >
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <!-- FlipView 占剩余空间 -->
                <RowDefinition Height="Auto"/>
                <!-- 按钮区域按内容高度 -->
            </Grid.RowDefinitions>


            
                
            <FlipView 
                Grid.Row="0"
                x:Name="FlipView_ModPreview" 
                >
                <FlipView.ContextFlyout>
                    <MenuFlyout>
                        <MenuFlyoutItem Text="添加新的预览图"
                                        Click="Button_ChangeModPreview_Click"
                            />
                        <MenuFlyoutItem Text="粘贴剪切板中的图片"
                                        Click="Button_PasteClipboardImage_Click"
                            />

                        <MenuFlyoutItem
                            x:Name="MenuFlyoutItem_DeleteThisModPreviewPicture"
                            Text="删除这张预览图"
                            Click="MenuFlyoutItem_DeleteThisModPreviewPicture_Click"
                            ></MenuFlyoutItem>
                        
                    </MenuFlyout>
                </FlipView.ContextFlyout>

                <FlipView.ItemTemplate>
                    <DataTemplate x:DataType="BitmapImage">
                        <Image Source="{Binding}" Stretch="Uniform"/>
                    </DataTemplate>
                </FlipView.ItemTemplate>
            </FlipView>
            
            <TextBlock 
                x:Name="TextBlock_ModPreviewTips"
                VerticalAlignment="Center"
                HorizontalAlignment="Center"
                Margin="5"
                Grid.Row="0" 
                Text="右键此处添加Mod预览图">
            </TextBlock>
            
            <Expander
                Grid.Row="1"
                HorizontalAlignment="Stretch"
                IsExpanded="True"
                VerticalAlignment="Top"
                Header="Mod按键列表">
                <community:DataGrid 
                    AutoGenerateColumns="False"  
                    MinHeight="100"
                    x:Name="DataGrid_ModKeyList"  
                    HorizontalAlignment="Stretch" 
                    >
                    <community:DataGrid.Columns>
                        <community:DataGridTextColumn Header="按键名称" MinWidth="220" Width="Auto" Binding="{Binding KeyName}" IsReadOnly="False"/>
                        <community:DataGridTextColumn Header="按键类型" Width="Auto" MinWidth="100" Binding="{Binding KeyType}" IsReadOnly="False"/>
                        <community:DataGridTextColumn Header="值"  Width="Auto" MinWidth="100" Binding="{Binding KeyValue}" IsReadOnly="False"/>
                    </community:DataGrid.Columns>
                </community:DataGrid>
            </Expander>
        </Grid>


        <!--设置页面-->
        <Border 
            Margin="5"
            Visibility="Collapsed"
            x:Name="Border_CategorySettings"
            Grid.Row="1" 
            Grid.Column="1" >
            
            <Border.Background>
                <AcrylicBrush 
                    TintColor="Black" 
                    TintOpacity="0.8" 
                    FallbackColor="Transparent"/>
            </Border.Background>

            <ScrollViewer Margin="10">
                <StackPanel Orientation="Vertical">
                    <controls:SettingsExpander 
                        IsExpanded="True"
                        Description="添加Mod的总分类"
                        Header="添加Mod分类">

                        <controls:SettingsExpander.Items>
                            <controls:SettingsCard 
                                Description="选一个小小的png图片代表这个分类"
                                Header="分类图标">

                                <StackPanel Orientation="Horizontal">
                                    <Image 
                                        x:Name="Image_AddCategoryPrimary" 
                                        Width="50" Height="50"></Image>
                                    <TextBox
                                        Visibility="Collapsed"
                                        x:Name="TextBox_ImageCategoryPrimaryPath"
                                        />

                                    <Button 
                                        Click="Button_AddCategoryPrimaryIcon_Click"
                                        x:Name="Button_AddCategoryPrimaryIcon"
                                        Content="选择分类图标"></Button>
                                </StackPanel>

                            </controls:SettingsCard>

                     
                            <controls:SettingsCard 
                                Description="指定当前分类的名称后添加分类"
                                Header="添加分类">
                                <StackPanel Orientation="Horizontal">
                                    <TextBox  
                                        x:Name="TextBox_AddCategoryPrimaryName"
                                        MinWidth="200"></TextBox>
                                    <Button 
                                        Click="Button_AddCategoryPrimary_Click"
                                        x:Name="Button_AddCategoryPrimary"
                                        Style="{StaticResource AccentButtonStyle}"
                                        Content="添加分类"/>
                                </StackPanel>
                            </controls:SettingsCard>

                        </controls:SettingsExpander.Items>
                    </controls:SettingsExpander>


                    <controls:SettingsExpander 
                        IsExpanded="True"
                        VerticalAlignment="Top"
                        Description="对象等于二级分类，相当于精确到某一个角色或物体"
                        Header="添加Mod对象">

                        <controls:SettingsExpander.Items>
                            <controls:SettingsCard 
                                Description="选一个小小的png图片代表这个对象"
                                Header="对象图标">

                                <StackPanel Orientation="Horizontal">
                                    <Image 
                                        x:Name="Image_AddCategorySecondary" 
                                        Width="50" Height="50"></Image>
                                    <TextBox
                                        Visibility="Collapsed"
                                        x:Name="TextBox_ImageCategorySecondaryPath"
                                        />
                                    <Button 
                                        Click="Button_AddCategorySecondaryIcon_Click"
                                        x:Name="Button_AddCategorySecondaryIcon"
                                        Content="选择对象图标"></Button>

                                </StackPanel>

                            </controls:SettingsCard>

                            <controls:SettingsCard 
                                Description="指定当前对象的名称后添加对象"
                                Header="添加对象">
                                <StackPanel Orientation="Horizontal">
                                    <TextBox  
                                        x:Name="TextBox_AddCategorySecondaryName"
                                        MinWidth="200"></TextBox>
                                    <Button 
                                        Click="Button_AddCategorySecondary_Click"
                                        x:Name="Button_AddCategorySecondary"
                                        Style="{StaticResource AccentButtonStyle}"
                                        Content="添加对象"/>
                                </StackPanel>
                            </controls:SettingsCard>

                        </controls:SettingsExpander.Items>
                    </controls:SettingsExpander>


                    <Button 
                        Style="{StaticResource AccentButtonStyle}"
                        Content="添加完成"
                        x:Name="Button_AddComplete" Margin="25" HorizontalAlignment="Center" Click="Button_AddComplete_Click"></Button>


                </StackPanel>
         
            </ScrollViewer>
        </Border>

    </Grid>
</Page>
